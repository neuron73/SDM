<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<script src="/lib/require.js"></script>
		<style>
			body {
				margin: 0px;
				padding: 0px;
				font-family: monospace;;
				font-size: 14px;
				height: 100%;
				width: 100%;
			}

			a {
				color: black;
			}

			a:hover {
				color: red;
			}
		</style>
		<script>
			(function() {
				var $ = require("utils", "web", "json");

				function query(query) {
					var xhr = new $.xhr();

					var a = [];
					for (var k in query) {
						a.push(k + "=" + query[k]);
					}
					xhr.open("GET", "/cgi-bin/SDM/SDM.pl?" + a.join("&"), false);
					xhr.overrideMimeType('text/plain; charset=x-user-defined');
					xhr.send("");
					return $.json.decode(xhr.responseText);
				}
				function print_terminals(terminals) {
					var container = $.$("terminals");
					var rows = [];
					$.every(terminals, function(terminal) {
						var reset= terminal.pwd == 1 ? 1 : 0;
						rows.push([
							$.span(String(terminal.id)),
							$.span($.utf8.decode(terminal.name)),
							$.span(terminal.email),
							$.e("a", {href: "", onclick: function() { password_reset(terminal.id, reset) }}, (reset ? "Сменить" : "Создать") + " пароль")]
						);
					});
					var table = $.table.apply($, rows);
					table.cellSpacing = 5;
					container.appendChild(table);
				}
				function password_reset(terminal_id, reset) {
					query({query: "password_reset", terminal: terminal_id, reset: reset});
				}
				window.onload = function() {
					var auth = query({query: "auth"});
					if (auth.user != "admin") {
						document.write("Доступ запрещен");
					} else {
						var terminals = query({query: "login_list"});
						print_terminals(terminals);
					}
				}
			})();
		</script>
	</head>
	<body>
		<div id="terminals"></div>
	</body>
</html>
